<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered 3D Building Creator</title>
    
    <!-- Include CesiumJS library -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .cesium-viewer-toolbar, .cesium-viewer-bottom {
            display: none !important;
        }
        #ai-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(38, 38, 38, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            color: #fff;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 10;
        }
        #ai-controls h3 {
            margin-top: 0;
            font-size: 18px;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        #ai-controls button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        #draw-button {
            background-color: #4CAF50;
            color: white;
        }
        #draw-button:hover {
            background-color: #45a049;
        }
        #draw-button.drawing {
             background-color: #f44336;
        }
        #draw-button.drawing:hover {
             background-color: #d32f2f;
        }
        #create-button {
            background-color: #008CBA;
            color: white;
        }
        #create-button:hover {
            background-color: #007ba7;
        }
        #create-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #ai-controls input {
            width: calc(100% - 20px);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #666;
            background-color: #333;
            color: #fff;
            margin-bottom: 10px;
        }
        #status-message {
            font-size: 12px;
            color: #ccc;
            min-height: 15px;
            text-align: center;
        }
        /* Data Form Modal Styles */
        #data-form-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-height: 80vh;
            background: rgba(48, 51, 57, 0.95);
            border-radius: 10px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            z-index: 20;
            color: #fff;
            padding: 20px;
        }
        #data-form-container {
            max-height: calc(80vh - 120px);
            overflow-y: auto;
            padding-right: 15px;
        }
        #data-form-modal h3 {
            text-align: center;
            margin-top: 0;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-grid label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #bbb;
        }
        .form-grid input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #666;
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
        }
        #data-form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
         #data-form-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
         }
         #save-data-button {
            background-color: #4CAF50;
            color: white;
         }
         #close-form-button {
            background-color: #f44336;
            color: white;
         }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="ai-controls">
        <h3>AI Building Creator</h3>
        <button id="draw-button">Start Drawing</button>
        <p id="status-message">Click 'Start Drawing' to create a building footprint.</p>
        <input type="text" id="ai-command" placeholder="e.g., 'Make it 15 floors high'">
        <button id="create-button" disabled>Create Building</button>
    </div>

    <!-- Data Form Modal -->
    <div id="data-form-modal">
        <h3>Building Information</h3>
        <div id="data-form-container">
            <form id="building-data-form">
                <div class="form-grid">
                    <div><label for="WKT">WKT</label><input type="text" id="WKT" name="WKT"></div>
                    <div><label for="full_addres_Q">full_addres_Q</label><input type="text" id="full_addres_Q" name="full_addres_Q"></div>
                    <div><label for="STREET_COD">STREET_COD</label><input type="text" id="STREET_COD" name="STREET_COD"></div>
                    <div><label for="BLDG_NUM">BLDG_NUM</label><input type="text" id="BLDG_NUM" name="BLDG_NUM"></div>
                    <div><label for="BLDG_TYPE">BLDG_TYPE</label><input type="text" id="BLDG_TYPE" name="BLDG_TYPE"></div>
                    <div><label for="NUM_FLOORS">NUM_FLOORS</label><input type="text" id="NUM_FLOORS" name="NUM_FLOORS"></div>
                    <div><label for="STREET_C_1">STREET_C_1</label><input type="text" id="STREET_C_1" name="STREET_C_1"></div>
                    <div><label for="BLDG_NUM_2">BLDG_NUM_2</label><input type="text" id="BLDG_NUM_2" name="BLDG_NUM_2"></div>
                    <div><label for="StreetIs_Tama">StreetIs_Tama</label><input type="text" id="StreetIs_Tama" name="StreetIs_Tama"></div>
                    <div><label for="No_Floors">No_Floors</label><input type="text" id="No_Floors" name="No_Floors"></div>
                    <div><label for="no_apt">no_apt</label><input type="text" id="no_apt" name="no_apt"></div>
                    <div><label for="ST_Code">ST_Code</label><input type="text" id="ST_Code" name="ST_Code"></div>
                    <div><label for="STREET_1">STREET_1</label><input type="text" id="STREET_1" name="STREET_1"></div>
                    <div><label for="color">color</label><input type="text" id="color" name="color"></div>
                    <div><label for="מיון_2">מיון_2</label><input type="text" id="מיון_2" name="מיון_2"></div>
                    <div><label for="masadcolor2">masadcolor2</label><input type="text" id="masadcolor2" name="masadcolor2"></div>
                    <div><label for="color_sofi">color_sofi</label><input type="text" id="color_sofi" name="color_sofi"></div>
                    <div><label for="full_addresse">full_addresse</label><input type="text" id="full_addresse" name="full_addresse"></div>
                    <div><label for="mi_address">mi_address</label><input type="text" id="mi_address" name="mi_address"></div>
                    <div><label for="codeapp">codeapp</label><input type="text" id="codeapp" name="codeapp"></div>
                </div>
            </form>
        </div>
        <div id="data-form-buttons">
            <button id="save-data-button">Save Data</button>
            <button id="close-form-button">Close</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyD7he1t-eLRUPOjUvbSfImIBLhKelaoQbw",
            authDomain: "cesium-building-creator.firebaseapp.com",
            projectId: "cesium-building-creator",
            storageBucket: "cesium-building-creator.appspot.com",
            messagingSenderId: "969094865431",
            appId: "1:969094865431:web:4f6b4b7324c4a3ca0a1b9c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4MWJmN2FlOC0wZjQ2LTRlMTUtYTExYS04YzMyYWVjNmUyNzMiLCJpZCI6MjI1NDgxLCJpYXQiOjE3NDA4MzE1Mzd9.o7sSlzZ3eyDevQejh5Q3zxlVpHfM4vX-49UTlwoCJkw';
        const geminiApiKey = 'AIzaSyD7he1t-eLRUPOjUvbSfImIBLhKelaoQbw';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: new Cesium.UrlTemplateImageryProvider({
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                subdomains: ['a', 'b', 'c'],
                credit: new Cesium.Credit('<a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap contributors</a>', false)
            }),
            infoBox: false,
            selectionIndicator: false,
            shouldAnimate: true,
            terrainProvider: new Cesium.EllipsoidTerrainProvider(),
        });
        
        // --- 2. UI & DRAWING SETUP ---
        const drawButton = document.getElementById('draw-button');
        const createButton = document.getElementById('create-button');
        const aiCommandInput = document.getElementById('ai-command');
        const statusMessage = document.getElementById('status-message');
        const dataFormModal = document.getElementById('data-form-modal');
        const saveDataButton = document.getElementById('save-data-button');
        const closeFormButton = document.getElementById('close-form-button');
        const buildingDataForm = document.getElementById('building-data-form');

        let isDrawing = false;
        let activeShapePoints = [];
        let extrudedBuilding;
        let currentBuildingId = null;
        // *** FIX: New variables for the stable drawing method ***
        let drawingEntities = []; 

        const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);

        handler.setInputAction(function (event) {
            if (isDrawing) {
                const earthPosition = viewer.camera.pickEllipsoid(event.position, viewer.scene.globe.ellipsoid);
                if (Cesium.defined(earthPosition)) {
                    activeShapePoints.push(earthPosition);
                    // *** FIX: Add visual points and lines instead of a callback-based polygon ***
                    const pointEntity = viewer.entities.add({
                        position: earthPosition,
                        point: {
                            color: Cesium.Color.RED,
                            pixelSize: 5,
                            heightReference: Cesium.HeightReference.NONE
                        }
                    });
                    drawingEntities.push(pointEntity);

                    if (activeShapePoints.length > 1) {
                        const lineEntity = viewer.entities.add({
                            polyline: {
                                positions: [activeShapePoints[activeShapePoints.length - 2], activeShapePoints[activeShapePoints.length - 1]],
                                width: 2,
                                material: Cesium.Color.CORAL
                            }
                        });
                        drawingEntities.push(lineEntity);
                    }
                }
            } else {
                const pickedObject = viewer.scene.pick(event.position);
                if (Cesium.defined(pickedObject) && Cesium.defined(pickedObject.id) && pickedObject.id.isBuilding) {
                     showDataForm(pickedObject.id);
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        
        handler.setInputAction(function (event) {
            if (isDrawing && activeShapePoints.length >= 3) {
                terminateShape();
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

        function clearDrawingAids() {
            drawingEntities.forEach(entity => viewer.entities.remove(entity));
            drawingEntities = [];
        }

        drawButton.addEventListener('click', () => {
            isDrawing = !isDrawing;
            if (isDrawing) {
                // Reset everything for a new drawing session
                if (extrudedBuilding) viewer.entities.remove(extrudedBuilding);
                clearDrawingAids();
                activeShapePoints = [];
                extrudedBuilding = null;
                currentBuildingId = null;
                
                drawButton.textContent = 'Finish Drawing';
                drawButton.classList.add('drawing');
                statusMessage.textContent = 'Click to add points. Double-click to finish.';
                createButton.disabled = true;
            } else {
                 if (activeShapePoints.length >= 3) {
                    terminateShape();
                } else {
                    resetDrawing();
                }
            }
        });
        
        function terminateShape() {
            // *** FIX: Clear the temporary points and lines ***
            clearDrawingAids();
            isDrawing = false;
            drawButton.textContent = 'Start New Drawing';
            drawButton.classList.remove('drawing');
            statusMessage.textContent = 'Footprint complete. Enter extrusion command.';
            createButton.disabled = false;
        }
        
        function resetDrawing() {
             clearDrawingAids();
             isDrawing = false;
             activeShapePoints = [];
             drawButton.textContent = 'Start Drawing';
             drawButton.classList.remove('drawing');
             statusMessage.textContent = 'Drawing cancelled.';
        }

        createButton.addEventListener('click', async () => {
            if (activeShapePoints.length < 3) {
                alert('Please draw a valid building footprint first.');
                return;
            }
            const command = aiCommandInput.value;
            if (!command) {
                alert('Please enter a command for the AI.');
                return;
            }

            statusMessage.textContent = 'AI is thinking...';
            createButton.disabled = true;

            try {
                const height = await getExtrusionHeightFromAI(command);
                if (height !== null) {
                    if (extrudedBuilding) {
                        viewer.entities.remove(extrudedBuilding);
                    }
                    
                    currentBuildingId = `building-${new Date().getTime()}`;

                    extrudedBuilding = viewer.entities.add({
                        id: currentBuildingId,
                        isBuilding: true,
                        polygon: {
                            hierarchy: new Cesium.PolygonHierarchy(activeShapePoints),
                            extrudedHeight: height,
                            material: Cesium.Color.YELLOW.withAlpha(0.9),
                            outline: true,
                            outlineColor: Cesium.Color.BLACK
                        }
                    });

                    statusMessage.textContent = `Building created with height: ${height}m.`;
                    showDataForm(extrudedBuilding);
                    activeShapePoints = []; // Clear points after use
                } else {
                    statusMessage.textContent = 'AI could not determine a height.';
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                statusMessage.textContent = 'Error communicating with AI.';
            } finally {
                createButton.disabled = false;
            }
        });

        // --- 3. DATA FORM & FIRESTORE LOGIC ---
        
        async function showDataForm(buildingEntity) {
            currentBuildingId = buildingEntity.id;
            buildingDataForm.reset();

            const docRef = doc(db, "buildings", currentBuildingId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                Object.keys(data).forEach(key => {
                    const input = buildingDataForm.elements[key];
                    if (input) {
                        input.value = data[key];
                    }
                });
            }
            
            dataFormModal.style.display = 'block';
        }

        closeFormButton.addEventListener('click', () => {
            dataFormModal.style.display = 'none';
            currentBuildingId = null;
        });

        saveDataButton.addEventListener('click', async () => {
            if (!currentBuildingId) return;

            const formData = new FormData(buildingDataForm);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                await setDoc(doc(db, "buildings", currentBuildingId), data);
                statusMessage.textContent = `Data saved for building ${currentBuildingId}`;
                dataFormModal.style.display = 'none';
                currentBuildingId = null;
            } catch (e) {
                console.error("Error adding document: ", e);
                statusMessage.textContent = 'Error saving data.';
            }
        });


        // --- 4. GEMINI API FUNCTION ---
        async function getExtrusionHeightFromAI(userCommand) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const prompt = `You are an assistant for a 3D mapping application. The user has provided an instruction to create a building. Your task is to determine the final height of the building in meters. Assume a standard floor is 3.5 meters high if the user specifies floors. Respond with ONLY the numerical value for the total height in meters. For example, if the user says 'make it 10 stories tall', you should respond with '35'. If the user says 'extrude to 100 feet', you should respond with '30.48'. If the user says 'build it 50 meters high', you should respond with '50'. User instruction: '${userCommand}'`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { console.error("API Error Response:", await response.text()); return null; }
            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts[0]) {
                const text = result.candidates[0].content.parts[0].text;
                const height = parseFloat(text.trim());
                return isNaN(height) ? null : height;
            }
            return null;
        }

        // --- 5. INITIAL SCENE SETUP ---
        async function initializeScene() {
            try {
                const osmBuildings = await Cesium.createOsmBuildingsAsync();
                viewer.scene.primitives.add(osmBuildings);
                osmBuildings.style = new Cesium.Cesium3DTileStyle({ color: "color('rgba(200, 200, 200, 0.8)')" });
                await viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(34.7818, 32.0853, 2500),
                    orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-45.0) }
                });
            } catch (error) {
                console.error("Failed to load scene assets: ", error);
            }
        }

        initializeScene();
    </script>
</body>
</html>
